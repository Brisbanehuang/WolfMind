# 问题修复记录

## 概览
记录近期在狼人杀项目中的问题、原因与修复方案，便于回溯与后续迭代。

## 1. 夜间讨论 thought 泄露
- **问题**：狼人夜间讨论时，私密思考 `thought` 被队友看到。
- **原因**：消息自动广播包含原始 metadata。
- **修复**：关闭自动广播，新增 `_make_public_msg` 只保留可公开字段（speech/behavior），广播前剥离 `thought`。同时白天讨论、遗言等场景统一使用去隐私广播。
- **位置**：`backend/core/game_engine.py`

## 2. 狼人对队友身份不确定
- **问题**：反思阶段狼人写出“如果是狼人/身份未知”等表述。
- **原因**：上下文未提供已知队友信息，提示词缺少约束。
- **修复**：
  - `_format_impression_context` 为狼人提供队友名单与存活状态。
  - 反思提示增加狼人专属提醒，强调已知队友身份。
- **位置**：`backend/core/game_engine.py`

## 3. 女巫重复毒杀被狼人击杀的目标
- **问题**：女巫在同一夜间会对已被狼人刀死的玩家再次使用毒药，导致不符合规则的双重击杀。
- **原因**：毒药候选列表未排除当晚被狼人击杀的玩家。
- **修复**：毒药候选只包含其他存活玩家，排除狼刀目标；提示文案同步说明“可毒杀的存活玩家（不含被狼人击杀者）”。
- **位置**：`backend/models/roles.py`


